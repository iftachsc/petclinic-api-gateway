
def microservicesGitBase = 'https://github.com/iftachsc/petclinic'
def microservices = ["api-gateway","vet-service", "visit-service", "customer-service"]
def otherMicoservices
def thisMicroservice = null
def javaS2iImage = "redhat-openjdk18-openshift:1.2"
def customerDbUser = "mysql"
def customerDbPwd = "mysql"
def customerDbName = "customer_db"
def customerDbServiceHost = "customer-db"
def customerDbServicePort = "3306"
def stagingProject = "petclinit-staging"
def stagingVersion = '1.5.9'
def cicdProject = "ci-cd"

//println(env.getEnvironment().collect({environmentVariable ->  "${environmentVariable.key} = ${environmentVariable.value}"}).join("\n"))
def commit = null
def committer = null
def integProject = null
def integProjectDisplay = null
def branch = null

node{
		
	stage('Unit Tests'){
		//checkout scm
		sh('ls')
		//sh('mvn compile test')
		sh('git status')
	}
	stage('Code Coverage'){
		//sh('mvn jacoco')
		sleep(5)
	}
	stage('Create project for integ') {
	//def projectDisplayName = "api-gateway-${scmVars.GIT_BRANCH}-${scmVars.GIT_COMMIT}"
		//getting current build openshift object
		openshift.withCluster() {
			openshift.withProject(cicdProject) {
					
				def reg = ~/^jenkins-ci-cd-/   
				def currentBuild = env.BUILD_TAG - reg
				thisMicroservice = currentBuild.replace("-microservice-pipeline-${env.BUILD_NUMBER}","")
				otherMicoservices = microservices - thisMicroservice  //microservices.removeAll{ it == thisMicroservice}
				println("This microservice: ${thisMicroservice}")
				
				def selector = openshift.selector("build", currentBuild)
				//selector.describe()
				
				def build = selector.object()
				println build.status.phase
				def rev = build.spec.triggeredBy[0].githubWebHook.revision.git
				commit = rev.commit
				committer = rev.committer
				println "Committer: ${committer}"
				println "Commit: ${commit}"
				integProject = "integ-tests-${thisMicroservice}-${env.BUILD_NUMBER}"
				integProjectDisplay = "Integ Tests ${thisMicroservice} #${env.BUILD_NUMBER}"
				
				checkout([$class: 'GitSCM', branches: [[name: commit ]],
				          userRemoteConfigs: [[url: "${microservicesGitBase}-${thisMicroservice}.git"]]])
				
				branch = sh(script: "git branch --contains ${commit}", returnStdout: true).trim()
				println "Branch: ${branch}"
			}
			
			openshift.newProject(integProject,"--display-name", "\"${integProjectDisplay}\"","--description","\"commit: ${commit}, committer: ${committer.name}\"")
			//sh("oc delete project ${integProject}")
		}
	}
	
	stage('Creating Openshift Apps'){
		openshift.withCluster() {
			openshift.withProject(integProject) {
				
				//deploy mysql for customer-service
				println "Creating Database service for customer-service"
				openshift.newApp("mysql-persistent","-p","MYSQL_USER=${customerDbUser}",
						                            "-p","MYSQL_PASSWORD=${customerDbPwd}",
						                            "-p","MYSQL_DATABASE=${customerDbName}",
						                            "-p","DATABASE_SERVICE_NAME=${customerDbServiceHost}")
				def imageStream = null                	
				otherMicoservices.each {
					println "Creating microservice ${it} in project ${integProject}"
					imageStream = "${stagingProject}/${it}:${stagingVersion}"
					def integImageStream = "${integProject}/${it}:${stagingVersion}"
					openshift.raw('tag',imageStream,integImageStream)
					if(it == "customer-service") {
//						openshift.newApp("${javaS2iImage}~${microservicesGitBase}-${it}","--name",it,
						openshift.newApp(integImageStream,"--name",it,
														   "-e","DB_USERNAME=${customerDbUser}",
								                            "-e","DB_PASSWORD=${customerDbPwd}",
								                            "-e","DB_NAME=${customerDbName}",
								                            "-e","DB_HOST=${customerDbServiceHost}",
								                            "-e","DB_PORT=${customerDbServicePort}")
					}
					else {
						//openshift.newApp("${javaS2iImage}~${microservicesGitBase}-${it}","--name",it)
						openshift.newApp(integImageStream,"--name",it)
					}
					openshift.raw('delete','svc',it)
					openshift.raw('expose','dc',it,"--port=8080")
				}
				
				println "Deploying this microservice: ${thisMicroservice}"
				//because of lang detection - we could just run it without the javaS2iImage
				//openshift.newApp("${javaS2iImage}~./#${branch}","--name", thisMicroservice)
				openshift.newApp("${javaS2iImage}~${microservicesGitBase}-${thisMicroservice}.git#feautre1","--name", thisMicroservice)
				
				println "Verifying builds:"
				timeout(10) {
					//## commenting since now only thisMicroservice is built. the rest is 
					//## via imagestream tag so they are not created with build/buildconfig so this will wait
					//## forever to find a completed build. 
//					microservices.each {
//						def buildSel = openshift.selector("bc", it)
//						buildSel.related('builds').untilEach(1) {
//							//def buildStatus = sh(script: "oc get build ${it}-1 -o jsonpath='{.status.phase}'", returnStdout: true).trim()
//							//since its the only build its #1
//							return it.object().status.phase == "Complete"
//						}
//						return false
//					}
					
					//#instaed checking on thisMicroserviceBuild
					def buildSel = openshift.selector("bc", thisMicroservice)
							buildSel.related('builds').untilEach(1) {
								return it.object().status.phase == "Complete"
							}
				}
				
				timeout(30) {
					microservices.each {
						def dcSelector = openshift.selector("dc", it)
						println "Verifying microservice deploy ${it}"
						dcSelector.related('pods').untilEach(1) {
		                    if (it.object().status.phase == 'Running') {
		                        return true;
		                    }
		                    return false;
						}	
					}
				}
                
			}
		}
	}
	
	stage('Run tests') {
		openshift.withCluster() {
			openshift.withProject(integProject) {
				
				openshift.raw('project',integProject)
				openshift.raw('expose','svc',thisMicroservice)
				
				//waiting for springboot to turn up since no healthchecks
				sleep(90)
				//pay attension os openshift.raw will use withCluster/withProject context. but sh(oc) will take jenkins's
				openshift.raw('project')
				
				//def apiGwEndpoint = sh(returnStdout: true, script: "oc get route -l app=api-gateway -o jsonpath='{.items[0].spec.host}'").trim()

				//api call - add owner
				def apiCommand = "curl -H \"Content-Type: application/json\" -X POST " + 
						"-d  '{\"firstName\":\"${integProject}\",\"lastName\":\"schonbaum\",\"address\":\"25th Helsinki st.\",\"city\":\"Tel Aviv\",\"telephone\":\"0528288288\"}' " +
						"http://localhost:8080/api/customer/owners"
			
				println "executing ${apiCommand}"
				
				openshift.selector("dc", "api-gateway").related('pods').withEach{
					podName = it.object().metadata.name
			        println sh(script: "oc rsh ${podName} ${apiCommand}",returnStdout: true).trim()	
				}
				
				def mysqlCommand = "/opt/rh/rh-mysql57/root/usr/bin/mysql -umysql -pmysql -hlocalhost -e 'select * from owners' customer_db"
				println "executing ${mysqlCommand}"
				openshift.selector("dc", "customer-db").related('pods').withEach{
					podName = it.object().metadata.name
					def mysqlOut = sh(script: "oc rsh ${podName} ${mysqlCommand}",returnStdout: true).trim()	
					println mysqlOut
					if(mysqlOut.contains(integProject))
					{
						println("it contains. Promoting app to staging")
					}
					else {
						error("sql entry didnt contain expected content")
					}
				}
			}
		}
	}
	stage('Promiting images') {
		openshift.withCluster() {
			openshift.withProject(cicdProject) {
				openshift.raw('tag',"${integProject}/${thisMicroservice}:latest","${stagingProject}/${thisMicroservice}:1.5.9")
			}
		}
	}
	stage('Destroying Integ env') {
		openshift.withCluster() {
			openshift.withProject(integProject) {
				//openshift.raw('delete','--all','all,pvc')
			}
			openshift.withProject(cicdProject) {
				//openshift.raw('delete','project',integProject)
			}
		}
	}
}
